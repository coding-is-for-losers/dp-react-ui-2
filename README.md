# dp-react-ui

![Build Status](https://codebuild.us-east-1.amazonaws.com/badges?uuid=eyJlbmNyeXB0ZWREYXRhIjoiMW1CcHBvNVF3S1BEVWFkOXNrYWxwRWlkeEZ6MXdqSlZYWGNFbThFZ2s0QnlKdXFtcEYrd0trQXJwSXRVdGNuWnRzdlUxM2dMcWlDZlJVVWk4SmZYV2RjPSIsIml2UGFyYW1ldGVyU3BlYyI6IjB2cW1WQlFmMWhHNTBITVoiLCJtYXRlcmlhbFNldFNlcmlhbCI6MX0%3D&branch=master)

Draft UI in React for front-end of Data Pipeline App.

To run locally, run `yarn install` locally in the folder, then `yarn start`.

## Notes for implementation

1.  Routes / Components for each page are primarily broken down in src/routes/dashboard.jsx and src/routes/pages.jsx (static pages).

2.  /dashboard will act as the homepage for logged in users, /register (needs to be renamed to /) for non logged-in users.

3.  There are many unused components in the repo - fat will be trimmed as soon as static marketing pages are completed.  

## HTTPS

We run on HTTPS locally to make it easier to test some of our integrations.
`yarn start` includes copying certificates generated by the backend into
the `webpack-dev-server` folder in `node_modules`. Make sure that your
backend is already running, and that it lives in a sibling folder named `dp2`.

## Deployment

### CodeBuild
A CodeBuild project exists for this repo that is configured to properly
inject configuration variables at build time, upload the latest build to S3,
and invalidate existing Cloudfront caches.

### Local Deployment
Avoid local deployment if possible.

You can deploy the site with `./scripts/s3-deploy`. Note that you must have
the backend server running locally to retrieve the GraphQL schema.

You must also pass the `STRIPE_API_KEY` environment variable, which should
include the `STRIPE_API_KEY`.


## New concepts in this UI

### 1. The idea of an 'analysis recipe', which consists of a combination of feed types.  

Concept here is that, via one form, a user can spin up all of the data feeds needed to run a particular analysis on a given site.  

A user will be able to create multiple sites (thinking one at a time) for any recipe.

The first 'recipe' we'll implement is that of a Website Quality Audit - consisting of data from Google Analytics, Search Console, SEMrush, Majestic and Deepcrawl.

Eventually, these recipes will also contain info on the Github repo containing SQL models (written in [DBT](https://getdbt.com)) to be run on the raw data once loaded - but for now we'll stick to just the feeds.


### 2. Connecting Github to read repos containing DBT projects.

We'll want to essentially add Github as a 'tap,' in order to read repos containing DBT projects that a user has access to (or be able to import an open-source repo for step #3).

Let's explore options for implementation here - it would be nice to be able to allow a user access to a private CIFL repo, without necessarily giving them read access to it (potentially doable by granting our app access via a service account rather than using OAuth).


### 3. Kicking off DBT models from Github to run on a trigger - either will be run by:

- Running DBT in our app as a module (https://docs.getdbt.com/v0.10/docs) - they have a currently undocumented API.
- Calling the Sinter API (https://github.com/fishtown-analytics/sinter-api-docs), which will require changes to the API (to allow posting of new projects / database creds).

Both of these options will require coordination with their team (which runs both projects) - CIFL has a working relationship with them.  My hunch is that we'll want to run DBT ourselves to keep our job scheduling consistent bw feeds + models.


### 4. Adding a dashboard visualization aspect to the app.

Reading in data from a given recipe / site combination to display metrics in-app.  

We'll also want to include instructions (in a static section of the visualization) for a user to read their data from BQ into a BI tool of their choice (Google Data Studio, Tableau, etc).


## Pages and actions on each page (top to bottom in dashboard sidebar)

### Getting Started (/getting-started)

Static page with walkthrough of setup process (needs screenshots / GIFs).

### Account Access (/api-auth)

Table of currently connected accounts, including placeholder rows showing 'connection required' for APIs requiring connection.  

Clicking 'connect' on a given row will link directly to the auth flow for that service (different flows for Google / Majestic etc).

A button at the bottom of the accounts table will also link to an 'add new account' flow, which will give the user to add a new account of any service.

Some accounts (for services like Majestic or SEMrush that only require an API key) may be provided out of the box to the user.  This is to avoid them having to pay for and log an API key - our master key will be provided to them.  

### + New Account (/new-api-connection)

Allows a user to select a new account type (Google etc) to add.

Links from each card will direct to a specific form for each service, as format of creds will differ (OAuth / API key etc).

### Analysis Recipe (/website-quality-audit as an example)

Table displaying info on each site implemented for a given recipe, and a status (either success or error: 'error details').  

Clicking on an individual site's row will lead to the site's 'Recipe + Site Detail Page', which will contain info on each individual feed within the recipe for that site.

At the bottom of the table will be links to 1) add a new site for the recipe, or 2) edit the recipe configuration (the feeds required + SQL models run).

A link to each recipe created by a user will be displayed in the sidebar (app may come pre-loaded with a recipe like the Website Quality Audit for users).

### Recipe + Site Detail (/recipe-site-detail)

Displays info + status (error / success) for each site within a recipe.

Given the complexities of backfilling data for a new feed, let's leave the only option on this page as 'Delete Site' for now, rather than allowing editing of a site for a given recipe after it's created.

### + New Site (/new-site)

Form flow to add a new site for a given recipe.  

Will display options for site name, domain (we'll strip protocol + www), and any required account info (GA account + property, GSC account + site, etc).

### + New Recipe (/new-recipe)

Wizard form flow to create a new analysis recipe.

Requires setting options in 3 steps:

1. Recipe name, description, and default backfill date
2. Checkbox selecting feeds required
3. (Future) Selection of Github repo containing the DBT project to be run on the raw data

### Register / Login / Pricing (/pages/register-page, /pages/login-page, /pages/pricing-page)

Static pages - /register will act as / for non logged-in users.


### Let's Eat (/dashboard)

(Future) Visualization of results for each site / analysis recipe combo.


## GraphQL Integration

To get this running, you'll need the admin running at `localhost:8003`.

You will need to run `yarn build-gql-types` to generate the type definitions
for union types, which we use to handle polymorphism on the GraphQL API.
